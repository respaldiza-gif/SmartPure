<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SmartPure – Control de Filtro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 480px;
      margin: auto;
      background: #ffffff;
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 4px;
      text-align: center;
    }

    .subtitle {
      font-size: 13px;
      color: #666;
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      font-size: 14px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }

    button {
      margin-top: 15px;
      border: none;
      cursor: pointer;
      background: #222;
      color: #fff;
    }

    button.secondary {
      background: #555;
    }

    button.danger {
      background: #b00020;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      font-size: 14px;
    }

    .ok { background: #e6f4ea; color: #1e7e34; }
    .warn { background: #fff4e5; color: #a15c00; }
    .bad { background: #fdecea; color: #b00020; }

    footer {
      margin-top: 30px;
      font-size: 12px;
      color: #777;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container">

    <h1>SmartPure</h1>
    <div class="subtitle">Control simple del cambio de filtro</div>

    <label>Fecha de instalación</label>
    <input type="date" id="installDate">

    <label>Ubicación</label>
    <select id="location">
      <option value="">Selecciona</option>
      <option value="Cocina">Cocina</option>
      <option value="Baño">Baño</option>
      <option value="Entrada principal">Entrada principal</option>
      <option value="Otro">Otro</option>
    </select>

    <label>Cantidad de personas en el hogar</label>
    <select id="people">
      <option value="">Selecciona</option>
      <option value="1-2">1 – 2 personas</option>
      <option value="3-4">3 – 4 personas</option>
      <option value="5+">5 o más personas</option>
    </select>

    <button onclick="saveData()">Guardar</button>

    <div id="statusBox"></div>

    <button class="secondary" onclick="addToCalendar()">Agregar recordatorio a Google Calendar</button>
    <button class="danger" onclick="resetData()">Resetear / Nuevo filtro</button>

    <footer>
      Funciona sin internet. Datos guardados solo en tu celular.
    </footer>

  </div>

<script>
  const STORAGE_KEY = "smartpure_filtro_data";

  function saveData() {
    const installDate = document.getElementById("installDate").value;
    const location = document.getElementById("location").value;
    const people = document.getElementById("people").value;

    if (!installDate || !people) {
      alert("Completa fecha y cantidad de personas.");
      return;
    }

    const data = {
      installDate,
      location,
      people
    };

    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    renderStatus();
  }

  function getDurationDays(people) {
    if (people === "1-2") return 180;
    if (people === "3-4") return 120;
    if (people === "5+") return 90;
    return 120;
  }

  function renderStatus() {
    const box = document.getElementById("statusBox");
    const saved = localStorage.getItem(STORAGE_KEY);

    if (!saved) {
      box.innerHTML = "";
      return;
    }

    const data = JSON.parse(saved);
    const install = new Date(data.installDate);
    const duration = getDurationDays(data.people);
    const changeDate = new Date(install);
    changeDate.setDate(changeDate.getDate() + duration);

    const today = new Date();
    const diffDays = Math.ceil((changeDate - today) / (1000 * 60 * 60 * 24));

    let statusClass = "ok";
    let text = `Filtro en buen estado. Próximo cambio en ${diffDays} días.`;

    if (diffDays <= 30 && diffDays > 0) {
      statusClass = "warn";
      text = `Atención: faltan ${diffDays} días para cambiar el filtro.`;
    }

    if (diffDays <= 0) {
      statusClass = "bad";
      text = `Debes cambiar el filtro ahora.`;
    }

    box.innerHTML = `
      <div class="status ${statusClass}">
        <strong>Ubicación:</strong> ${data.location || "No especificada"}<br>
        <strong>Estado:</strong> ${text}<br>
        <strong>Fecha estimada de cambio:</strong> ${changeDate.toLocaleDateString()}
      </div>
    `;
  }

  function pad(n) {
    return String(n).padStart(2, '0');
  }

  function toGCalUTCString(date) {
    return (
      date.getUTCFullYear() +
      pad(date.getUTCMonth() + 1) +
      pad(date.getUTCDate()) +
      "T" +
      pad(date.getUTCHours()) +
      pad(date.getUTCMinutes()) +
      pad(date.getUTCSeconds()) +
      "Z"
    );
  }

  function addToCalendar() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) {
      alert("Primero guarda los datos.");
      return;
    }

    const data = JSON.parse(saved);
    const install = new Date(data.installDate);
    const duration = getDurationDays(data.people);
    const changeDate = new Date(install);
    changeDate.setDate(changeDate.getDate() + duration);
    changeDate.setHours(9,0,0,0);

    const endDate = new Date(changeDate.getTime() + 15 * 60000);

    const text = encodeURIComponent("Cambio de filtro SmartPure");
    const details = encodeURIComponent(
      `Cambio de filtro de agua.\n` +
      `Ubicación: ${data.location || "No especificada"}\n` +
      `Personas: ${data.people}\n\n` +
      `Escanea el QR y presiona RESET luego del cambio.`
    );

    const dates = `${toGCalUTCString(changeDate)}/${toGCalUTCString(endDate)}`;
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}`;

    window.open(url, "_blank");
  }

  function resetData() {
    if (confirm("¿Seguro que deseas resetear para un nuevo filtro?")) {
      localStorage.removeItem(STORAGE_KEY);
      document.getElementById("installDate").value = "";
      document.getElementById("location").value = "";
      document.getElementById("people").value = "";
      document.getElementById("statusBox").innerHTML = "";
    }
  }

  renderStatus();
</script>

</body>
</html>
